# かくきんシステムの使い方

かくきんシステム（確率均等化システム；Probabilistic Evenizing System）の Excel シートの見方を説明します。  

その前に、Excel シートを生成するのに使ったプログラムのソースコードの置き場所を示しておきます。  

* 📖 [GitHubリポジトリー ＞ muzudho/sente-win-rate-70-percent-problem](https://github.com/muzudho/sente-win-rate-70-percent-problem) - ファンシーなコーディングをしているので難読かもしれません  


# Excel シートの見方の説明

📄 `auto_generated_kakukin_data_try2000_alter.xlsx` ファイルと、  
📄 `auto_generated_kakukin_data_try2000_froze.xlsx` ファイルを Excel で開いてください  

これらの２つは（別ブックとして開いているだけでよく、直接は操作しないので）ウィンドウを最小化しておいてください  


そのあとに  

📄 `kakukin_viewer.xlsx` ファイルを Excel で開いてください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの B7 セルに `auto_generated_kakukin_data_try2000_alter.xlsx` と入力してください。（バッククォートは入力しないでください。以下同様）  
📄 `kakukin_viewer.xlsx` ファイルの Rule シートの B9 セルに `f10.0per` と入力してください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 13行目～43行目は、シートの見方になっているので、必要になったらご覧ください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 50行目以降がデータになっています  


例えば将棋の先手勝率が７割、引分けが１割の場合、  
📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 251行目～258行目を見てください  

以下のように書いてあります。  
同シート F列 253行目付近には　［将棋の先手勝率　70%］  
同シート H列 253行目付近には　［将棋の引分け率　10%］  
同シート J列 253行目付近には　［手番の決め方　先後交互制］  
同シート L列 253行目付近には　［先手で勝ち 1 点］  
同シート N列 253行目付近には　［後手で勝ち 2 点］  
同シート P列 253行目付近には　［シリーズ勝利条件 3 点先取］  
同シート W列 253行目付近には　［上限 6 局］  
同シート Y列 255行目付近には　［期待値　Ａさんの勝率 51.9 %］  
同シート Y列 257行目付近には　［期待値　引分け率 1.6 %］  


これは、Ａさんが先手、Ｂさんが後手で番勝負（シリーズ）を行い、  
先手番で勝ったとき　１点の勝ち点がもらえ、  
後手番で勝ったとき　２点の勝ち点がもらえ、  
引分けのとき　勝ち点は入らず１局を消化するとし、  
先に　３点の勝ち点を先取した方のプレイヤーがシリーズの勝者とする。  
ただし対局は最大で６局まで行い延長は無いものとし、  
決着が付かなかった場合　勝ち点が多い方をシリーズの勝者とする。  
それでも決着が付かなかった場合、大会運営のルールで別途引分け時の対応を決めるものとする。  

このような大会ルールにしたとき、  
期待値が約　１．６％の確率で引分けになり、  
期待値が約９８．４％の確率でＡさんとＢさんのどちらの勝ちか決着が付く。  
そして、決着が付いたケースでは  
期待値が約５１。９％の確率でＡさんの勝ち、  
期待値が約４８．１％の確率でＢさんの勝ちとなる  


以上をシミュレーション結果は、以下のように書いてあります。  
同シート AA列 253行目付近には　［試行 2000 ｼﾘｰｽﾞ]   
同シート AD列 257行目付近には　［Ａさんの勝ち　52.9%]   
同シート AI列 257行目付近には　［Ｂさんの勝ち　47.1%]   
同シート CA列 257行目付近には　［引分け　1.8%]   

2000回の試行なので、ばらつきがあるものの、無限回試行すれば期待値に近づくと思われます。  


# Excel シートの見方の説明への備考

［かくきんシステム］のこれらのデータは力任せ探索のローラー作戦で小さな値から掘っているので、  
時間をかけるとより先手勝率５０％に近づけるルールが見つかると思いますが、  
その場合は　対局の上限数が何十局、何百局にも伸びていくと思うので、候補の中から適度なルールを選ぶことになると思います。  


# 期待値の計算方法

先手の勝率を p、  
後手の勝率を q、  
引分ける確率を f とします  

p と q は確率論で使われている変数名、 f は failure rate の頭文字から取りました  

p + q = 1 になります。  
引分け率も含めたときの全体の内での先手勝率は (1 - f) * p で計算できます。  
当然、  
(1 - f) * p + (1 - f) * q + f = 1 になります  

例：  
p = 0.7  
q = 0.3  
f = 0.1 のとき、  

(1 - 0.1) * 0.7 + (1 - 0.1) * 0.3 + 0.1 = 1  

Python では、小数点以下を２進数では表現できないことがあるからか、検算がずれることがあります。  
このずれを完全に取り除くことは **できていません**。 Excel の表が元にしているデータにずれが含まれているかもしれません。  

