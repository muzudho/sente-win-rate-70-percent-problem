# かくきんシステムの使い方

かくきんシステム（確率均等化システム；Probabilistic Evenizing System）の Excel シートの見方を説明します。  

その前に、Excel シートを生成するのに使ったプログラムのソースコードの置き場所を示しておきます。  

* 📖 [GitHubリポジトリー ＞ muzudho/sente-win-rate-70-percent-problem](https://github.com/muzudho/sente-win-rate-70-percent-problem) - ファンシーなコーディングをしているので難読かもしれません  


# Excel シートの見方の説明

📄 `auto_generated_kakukin_data_try2000_alter.xlsx` ファイルと、  
📄 `auto_generated_kakukin_data_try2000_froze.xlsx` ファイルを Excel で開いてください  

これらの２つは（別ブックとして開いているだけでよく、直接は操作しないので）ウィンドウを最小化しておいてください  


そのあとに  

📄 `kakukin_viewer.xlsx` ファイルを Excel で開いてください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの B7 セルに `auto_generated_kakukin_data_try2000_alter.xlsx` と入力してください。（バッククォートは入力しないでください。以下同様）  
📄 `kakukin_viewer.xlsx` ファイルの Rule シートの B9 セルに `f10.0per` と入力してください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 13行目～43行目は、シートの見方になっているので、必要になったらご覧ください  

📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 50行目以降がデータになっています  


例えば将棋の先手勝率が７割、引分けが１割の場合、  
📄 `kakukin_viewer.xlsx` ファイルの Rule シートの 251行目～258行目を見てください  

以下のように書いてあります。  
同シート F列 253行目付近には　［将棋の先手勝率　70%］  
同シート H列 253行目付近には　［将棋の引分け率　10%］  
同シート J列 253行目付近には　［手番の決め方　先後交互制］  
同シート L列 253行目付近には　［先手で勝ち 1 点］  
同シート N列 253行目付近には　［後手で勝ち 2 点］  
同シート P列 253行目付近には　［シリーズ勝利条件 3 点先取］  
同シート W列 253行目付近には　［上限 6 局］  
同シート Y列 255行目付近には　［期待値　Ａさんの勝率 51.9 %］  
同シート Y列 257行目付近には　［期待値　引分け率 1.6 %］  


これは、Ａさんが先手、Ｂさんが後手で番勝負（シリーズ）を行い、  
先手番で勝ったとき　１点の勝ち点がもらえ、  
後手番で勝ったとき　２点の勝ち点がもらえ、  
引分けのとき　勝ち点は入らず１局を消化するとし、  
先に　３点の勝ち点を先取した方のプレイヤーがシリーズの勝者とする。  
ただし対局は最大で６局まで行い延長は無いものとし、  
決着が付かなかった場合　勝ち点が多い方をシリーズの勝者とする。  
それでも決着が付かなかった場合、大会運営のルールで別途引分け時の対応を決めるものとする。  

このような大会ルールにしたとき、  
期待値が約　１．６％の確率で引分けになり、  
期待値が約９８．４％の確率でＡさんとＢさんのどちらの勝ちか決着が付く。  
そして、決着が付いたケースでは  
期待値が約５１。９％の確率でＡさんの勝ち、  
期待値が約４８．１％の確率でＢさんの勝ちとなる  


以上をシミュレーション結果は、以下のように書いてあります。  
同シート AA列 253行目付近には　［試行 2000 ｼﾘｰｽﾞ]   
同シート AD列 257行目付近には　［Ａさんの勝ち　52.9%]   
同シート AI列 257行目付近には　［Ｂさんの勝ち　47.1%]   
同シート CA列 257行目付近には　［引分け　1.8%]   

2000回の試行なので、ばらつきがあるものの、無限回試行すれば期待値に近づくと思われます。  


# Excel シートの見方の説明への備考

［かくきんシステム］のこれらのデータは力任せ探索のローラー作戦で小さな値から掘っているので、  
時間をかけるとより先手勝率５０％に近づけるルールが見つかると思いますが、  
その場合は　対局の上限数が何十局、何百局にも伸びていくと思うので、候補の中から適度なルールを選ぶことになると思います。  


# 計算方法


## はじめに

先手の勝率を p、  
後手の勝率を q、  
引分ける確率を f とします  

p と q は確率論で使われている変数名、 f は failure rate の頭文字から取りました  

p + q = 1 になります。  
引分け率も含めたときの全体の内での先手勝率は (1 - f) * p で計算できます。  
当然、  
(1 - f) * p + (1 - f) * q + f = 1 になります  

例：  
p = 0.7  
q = 0.3  
f = 0.1 のとき、  

(1 - 0.1) * 0.7 + (1 - 0.1) * 0.3 + 0.1 = 1  

Python では、小数点以下を２進数では表現できないことがあるからか、検算がずれることがあります。  
このずれを完全に取り除くことは **できていません**。 Excel の表が元にしているデータにずれが含まれているかもしれません。  


## ［最短対局数］の求め方


### ［最短対局数］の求め方　＞　［先後固定制］

［**先後固定制**］は、駒落ちのように、Ａさんがずっと上手、Ｂさんはずっと後手といったように先後が固定されているケースです。先後が固定されたまま番勝負を行います  

裏が全勝したときの対局数と、最短対局数は等しいです  

シリーズ勝利条件の目標となる勝ち点を **span**、  
後手で勝ったときにもらえる勝ち点を **t_step** と書くとします。（t はコインの裏を意味する Tail の頭文字）  

```
最短対局数 = span / t_step
```

span は t_step と **h_step**（先手で勝ったときにもらえる勝ち点）との最小公倍数なので割り切れます  

例：  
span = 10  
t_step = 2  
h_step = 1 のとき  

```
                1   2   3   4   5
        あと    裏  裏  裏  裏  裏
Ａさん    10点  10  10  10  10  10
Ｂさん    10点   8   6   4   2   0
```

で、最短５局  


### ［最短対局数］の求め方　＞　［先後交互制］

［**先後交互制**］は、番勝負の１局目にＡさんが先手、Ｂさんが後手を持ち、以降１局毎に先後を交代する方法です  

Ｂさんだけが勝ったときの対局数と、最短対局数は等しいです  

`def let_shortest_coins` でソースコードを全文検索してください。アルゴリズムが書かれています  


## ［上限対局数］の求め方


### ［上限対局数］の求め方　＞　引分け率が０％のケース


#### ［上限対局数］の求め方　＞　引分け率が０％のケース　＞　［先後固定制］

先手だけが勝ち続けて番勝負が終わったときの対局数を **h_time** と書くとします  

h_time = span / h_step  

後手だけが勝ち続けて番勝負が終わったときの対局数を **t_time** と書くとします  

t_time = span / t_step  

```
上限対局数 = h_time + t_time - 1
```

#### ［上限対局数］の求め方　＞　引分け率が０％のケース　＞　［先後交互制］

```
上限対局数 = 2 * h_time - 1
```


### ［上限対局数］の求め方　＞　引分け率が０％より大きいケース

```
上限対局数 = 小数点以下切上(引分け率が０％のときの上限対局数 / (1 - f))
```

引分け率が存在するとき、ただ対局数を伸ばすしか方法は見つかりませんでした  


## ［Ａさんの勝率］の期待値、［引分け率］の期待値の求め方

まず、大会ルールを以下のように定義します。これらの値をいくつにするかは、力任せ探索で全パターンを調べていくしかありません  

span = 2
t_step = 2
h_step = 1

以上の３つが決まると、最短対局数 **shortest_coins** と、上限対局数 **upper_limit_coins** も計算で求まります  

shortest_coins = 1
upper_limit_coins = 4

以上の５つが決まると、アルゴリズムにより、以下のようなツリー構造を作成できます。  
引分けを失（失敗の頭文字）と表記するとします。葉ノードの数は２７個です。  
確率の計算方法はあとで説明します  

```
No  出目          勝ち点の推移            結果
--  -----------  ---------------------  -----------------
 1  表,表,表      Ａさん  1  1  2        達成でＡさんの勝ち
                 Ｂさん   0  1  1
 2  表,表,裏      Ａさん  1  1  0        達成でＢさんの勝ち
                 Ｂさん   0  1  3
 3  表,表,失,表   Ａさん  1  1  1  1     達成でＢさんの勝ち
                 Ｂさん   0  1  1  2
 4  表,表,失,裏   Ａさん  1  1  1  3     達成でＡさんの勝ち
                 Ｂさん  0  1  1  1
 5  表,表,失,失   Ａさん  1  1  1  1     勝者なし
                 Ｂさん  0  1  1  1
 6  表,裏         Ａさん  1  3           達成でＡさんの勝ち
                 Ｂさん  0  0
 7  表,失,表      Ａさん  1  1  2        達成でＡさんの勝ち
                 Ｂさん  0  0  0
 8  表,失,裏      Ａさん  1  1  1        達成でＢさんの勝ち
                 Ｂさん  0  0  2
 9  表,失,失,表   Ａさん  1  1  1  1      勝者なし
                 Ｂさん  0  0  0  1
10  表,失,失,裏   Ａさん  1  1  1  3      達成でＡさんの勝ち
                 Ｂさん  0  0  0  0
11  表,失,失,失   Ａさん  1  1  1  1      勝ち点差でＡさんの勝ち
                 Ｂさん  0  0  0  0
12  裏            Ａさん  0               達成でＢさんの勝ち
                 Ｂさん  2
13  失,表,表,表   Ａさん  0  0  1  1      達成でＢさんの勝ち
                 Ｂさん  0  1  1  2
14  失,表,表,裏   Ａさん  0  0  1  3      達成でＡさんの勝ち
                 Ｂさん  0  1  0  0
15  失,表,表,失   Ａさん  0  0  1  0       勝者なし
                 Ｂさん  0  1  1  0
16  失,表,裏      Ａさん  0  0  0          達成でＢさんの勝ち
                 Ｂさん  0  1  3
17  失,表,失,表   Ａさん  0  0  0  0       達成でＢさんの勝ち
                 Ｂさん  0  1  1  3
18  失,表,失,裏   Ａさん  0  0  0  2       達成でＡさんの勝ち
                 Ｂさん  0  1  1  1
19  失,表,失,失   Ａさん  0  0  0  0       勝ち点差でＢさんの勝ち
                 Ｂさん  0  1  1  1
20  失,裏         Ａさん  0  2             達成でＡさんの勝ち
                 Ｂさん  0  0
21  失,失,表,表   Ａさん  0  0  1  1        勝者なし
                 Ｂさん  0  0  0  1
22  失,失,表,裏   Ａさん  0  0  1  3        達成でＡさんの勝ち
                 Ｂさん  0  0  0  0
23  失,失,表,失   Ａさん  0  0  1  0        勝ち点差でＡさんの勝ち
                 Ｂさん  0  0  0  0
24  失,失,裏      Ａさん  0  0  0           達成でＢさんの勝ち
                 Ｂさん  0  0  2
25  失,失,失,表   Ａさん  0  0  0  0        勝ち点差でＢさんの勝ち
                 Ｂさん  0  0  0  1
26  失,失,失,裏   Ａさん  0  0  0  2        達成でＡさんの勝ち
                 Ｂさん  0  0  0  0
27  失,失,失,失   Ａさん  0  0  0  0        勝者なし
                 Ｂさん  0  0  0  0
```


ツリー構造の形を図（樹形図）にしてみます。`Ａ(表)1` は、Ａさんが表番で勝って勝ち点が1になったことを意味します  


```
--+---Ａ(表)1--+---Ｂ(表)1--+-->Ａ(表)2                 1  達成でＡさんの勝ち
  |            |           |
  |            |           +-->Ｂ(裏)3                 2  達成でＢさんの勝ち
  |            |           |
  |            |           +---失-------+-->Ｂ(表)2    3  達成でＢさんの勝ち
  |            |                        |
  |            |                        +-->Ａ(裏)3    4  達成でＡさんの勝ち
  |            |                        |
  |            |                        +-->失         5  勝者なし
  |            |
  |            +-->Ａ(裏)3                             6  達成でＡさんの勝ち
  |            |
  |            +---失------+-->Ａ(表)2                 7  達成でＡさんの勝ち
  |                        |
  |                        +-->Ｂ(裏)2                 8  達成でＢさんの勝ち
  |                        |
  |                        +---失-------+-->Ｂ(表)1    9  勝者なし
  |                                     |
  |                                     +-->Ａ(裏)3   10  達成でＡさんの勝ち
  |                                     |
  |                                     +-->失        11  勝ち点差でＡさんの勝ち
  |
  +-->Ｂ(裏)2                                         12  達成でＢさんの勝ち
  |
  +---失-----+---Ｂ(表)1--+---Ａ(表)1----+-->Ｂ(表)2   13  達成でＢさんの勝ち
             |            |             |
             |            |             +-->Ａ(裏)3   14  達成でＡさんの勝ち
             |            |             |
             |            |             +-->失        15  勝者なし
             |            |
             |            +-->Ｂ(裏)3                 16  達成でＢさんの勝ち
             |            |
             |            +---失--------+-->Ｂ(表)2   17  達成でＢさんの勝ち
             |                          |
             |                          +-->Ａ(裏)2   18  達成でＡさんの勝ち
             |                          |
             |                          +-->失        19  勝ち点差でＢさんの勝ち
             |
             +-->Ａ(裏)2                              20  達成でＡさんの勝ち
             |
             +---失-------+---Ａ(表)1----+-->Ｂ(表)1   21  勝者なし
                          |             |
                          |             +-->Ａ(裏)3   22  達成でＡさんの勝ち
                          |             |
                          |             +-->失        23  勝ち点差でＡさんの勝ち
                          |
                          +-->Ｂ(裏)2                 24  達成でＢさんの勝ち
                          |
                          +---失-------+-->Ｂ(表)1    25  勝ち点差でＢさんの勝ち
                                       |
                                       +-->Ａ(裏)2    26  達成でＡさんの勝ち
                                       |
                                       +-->失         27  勝者なし
```


ツリー構造が判明してから、確率を計算していきます  



例：  
p = 0.6  
q = 0.4  
f = 0.1 のとき、  

以下を追加で定義します。 s は success rate の頭文字としました  

s = (1 - f)
sp = s * p
sq = s * q

例：  
s = 0.9 = (1 - 0.1)
sp = 0.54 = 0.9 * 0.6
sq = 0.36 = 0.9 * 0.4
1 = sp + sq + f


試行の１回目の結果は以下のようになります  

```
                 １局目     結果
                 ------    ----------------
1 --+-->Ａ(表)1   0.54     ２局目に続く
    |
    +-->Ｂ(裏)2   0.36     達成でＢさんの勝ち
    |
    +-->失        0.1      ２局目に続く

                 ------
TOTAL             1
```


試行の２回目の結果は以下のようになります  

```
                  １局目                ２局目     結果
                  ------                -------   -----------------
1 --+-->Ａ(表)1    0.54 --+-->Ｂ(表)1    0.2916    ３局目に続く
    |                     |
    |                     +-->Ａ(裏)3    0.1944    達成でＡさんの勝ち
    |                     |
    |                     +-->失         0.054     ３局目に続く
    |
    +-->Ｂ(裏)2    0.36                  0.36      達成でＢさんの勝ち
    |
    +-->失         0.1  --+-->Ｂ(表)1    0.054     ３局目に続く
                          |
                          +-->Ａ(裏)2    0.036     達成でＡさんの勝ち
                          |
                          +-->失         0.01      ３局目に続く

                  ------                -------
TOTAL              1                     1


3局目に続く        0.4096  =  0.2916 + 0.054 + 0.054 + 0.01
達成でＢさんの勝ち  0.36
達成でＡさんの勝ち  0.2304  =  0.1944 + 0.036
                  -------
                  1
```


試行の３回目の結果は以下のようになります  

```
                  １局目                ２局目                   ３局目       結果
                  ------                -------                 ---------   -----------------
1 --+-->Ａ(表)1    0.54 --+-->Ｂ(表)1    0.2916 --+-->Ａ(表)2     0.157464    達成でＡさんの勝ち
    |                     |                      |
    |                     |                      +-->Ｂ(裏)3     0.104976    達成でＢさんの勝ち
    |                     |                      |
    |                     |                      +-->失          0.02916     ４局目に続く
    |                     |
    |                     +-->Ａ(裏)3    0.1944                  0.1944      達成でＡさんの勝ち
    |                     |
    |                     +-->失         0.054  --+-->Ａ(表)2    0.02916     達成でＡさんの勝ち
    |                                             |
    |                                             +-->Ｂ(裏)2    0.01944     達成でＢさんの勝ち
    |                                             |
    |                                             +-->失         0.0054      ４局目に続く
    |
    +-->Ｂ(裏)2  0.36                    0.36                    0.36        達成でＢさんの勝ち
    |
    +-->失       0.1   --+-->Ｂ(表)2     0.054  --+-->Ａ(表)1     0.02916     ４局目に続く
                         |                        |
                         |                        +-->Ｂ(裏)3    0.01944     達成でＢさんの勝ち
                         |                        |
                         |                        +-->失         0.0054      ４局目に続く
                         |
                         +-->Ａ(裏)2     0.036                   0.036       達成でＡさんの勝ち
                         |
                         +-->失          0.01   --+-->Ａ(表)1    0.0054      ４局目に続く
                                                  |
                                                  +-->Ｂ(裏)2    0.0036      達成でＢさんの勝ち
                                                  |
                                                  +-->失         0.001       ４局目に続く

                ------                  -------                 -------
TOTAL           1                       1                       1


達成でＢさんの勝ち  0.507456  =  0.104976 + 0.01944 + 0.36 + 0.01944 + 0.0036
達成でＡさんの勝ち  0.417024  =  0.157464 + 0.1944 + 0.02916 + 0.036
４局目に続く        0.07552  =   0.02916 + 0.0054 + 0.02916 + 0.0054 + 0.0054 + 0.001
                  ---------
                  1
```


試行の４回目の結果は以下のようになります  

```
                 １局目                 ２局目                  ３局目                      ４局目       結果
                 ------                -------                 ---------                  ---------   --------------------
1 --+-->Ａ(表)1   0.54 --+-->Ｂ(表)1    0.2916 --+-->Ａ(表)2     0.157464                   0.157464    達成でＡさんの勝ち
    |                    |                      |
    |                    |                      +-->Ｂ(裏)3     0.104976                   0.104976     達成でＢさんの勝ち
    |                    |                      |
    |                    |                      +-->失          0.02916   --+-->Ｂ(表)2    0.0157464    達成でＢさんの勝ち
    |                    |                                                  |
    |                    |                                                  +-->Ａ(裏)3    0.0104976    達成でＡさんの勝ち
    |                    |                                                  |
    |                    |                                                  +-->失         0.002916     勝者なし
    |                    |
    |                    +-->Ａ(裏)3    0.1944                  0.1944                     0.1944       達成でＡさんの勝ち
    |                    |
    |                    +-->失         0.054  --+-->Ａ(表)2    0.02916                    0.02916      達成でＡさんの勝ち
    |                                            |
    |                                            +-->Ｂ(裏)2    0.01944                    0.01944      達成でＢさんの勝ち
    |                                            |
    |                                            +-->失         0.0054    --+-->Ｂ(表)1    0.002916     勝者なし
    |                                                                       |
    |                                                                       +-->Ａ(裏)3    0.001944     達成でＡさんの勝ち
    |                                                                       |
    |                                                                       +-->失         0.00054      勝ち点差でＡさんの勝ち
    |
    +-->Ｂ(裏)2   0.36                  0.36                    0.36                       0.36         達成でＢさんの勝ち
    |
    +-->失        0.1  --+-->Ｂ(表)1    0.054  --+-->Ａ(表)1    0.02916   --+-->Ｂ(表)2    0.0157464     達成でＢさんの勝ち
                         |                      |                          |
                         |                      |                          +-->Ａ(裏)3    0.0104976     達成でＡさんの勝ち
                         |                      |                          |
                         |                      |                          +-->失         0.002916      勝者なし
                         |                      |
                         |                      +-->Ｂ(裏)3    0.01944                    0.01944       達成でＢさんの勝ち
                         |                      |
                         |                      +-->失         0.0054    --+-->Ｂ(表)2    0.002916      達成でＢさんの勝ち
                         |                                                 |
                         |                                                 +-->Ａ(裏)2    0.001944      達成でＡさんの勝ち
                         |                                                 |
                         |                                                 +-->失         0.00054       勝ち点差でＢさんの勝ち
                         |
                         +-->Ａ(裏)2    0.036                  0.036                      0.036         達成でＡさんの勝ち
                         |
                         +-->失         0.01   --+-->Ａ(表)1   0.0054    --+-->Ｂ(表)1     0.002916      勝者なし
                                                 |                        |
                                                 |                        +-->Ａ(裏)3     0.001944      達成でＡさんの勝ち
                                                 |                        |
                                                 |                        +-->失          0.00054       勝ち点差でＡさんの勝ち
                                                 |
                                                 +-->Ｂ(裏)2   0.0036                     0.0036        達成でＢさんの勝ち
                                                 |
                                                 +-->失        0.001     --+-->Ｂ(表)1    0.00054       勝ち点差でＢさんの勝ち
                                                                          |
                                                                          +-->Ａ(裏)2     0.00036       達成でＡさんの勝ち
                                                                          |
                                                                          +-->失          0.0001        勝者なし

                 ----                   -----                  --------                  ----------
TOTAL            1                      1                      1                          1


達成でＢさんの勝ち      0.5418648  =  0.104976 + 0.0157464 + 0.01944 + 0.36 + 0.0157464 + 0.01944 + 0.002916 + 0.0036
達成でＡさんの勝ち      0.4442112  =  0.157464 + 0.0104976 + 0.1944 + 0.02916 + 0.001944 + 0.0104976 + 0.001944 + 0.036 + 0.001944 + 0.00036
勝者なし               0.011764   =  0.002916 + 0.002916 + 0.002916 + 0.002916 + 0.0001
勝ち点差でＡさんの勝ち  0.00108    =  0.00054 + 0.00054
勝ち点差でＢさんの勝ち  0.00108    =  0.00054 + 0.00054
                      ----------
                      1

Ａさんの勝ち           0.4452912 = 0.4442112 + 0.00108
Ｂさんの勝ち           0.5429448 = 0.5418648 + 0.00108
勝者なし               0.011764
                      ---------
                      1

FIXME: 検算中。内部的な値と一致しない？端数が付いているのでは？

Ａさんの勝率          = 0.45059196386288297
Ｂさんの勝率          = 0.549408036137117
勝ち負けが付かない確率 = 0.011764000000000002
確率合計              = 1.0000000000000002
```

この方法で、Ａさんの勝率の期待値や、引分けの期待値が求まります  
